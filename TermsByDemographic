SELECT SUBSTR(SVC.actual_termination_date, 4, 6) AS "Month",
  'SEPARATIONS'                                  AS "Data Flag",
  HR_CC_DEPT_MAP.LIST_VALUE_LONG_DESC            AS "Dept by CC",
  HR_LOC_REGION_MAP.LIST_VALUE_LONG_DESC         AS "Region",
  HR_LOC_COUNTRY_MAP.LIST_VALUE_LONG_DESC        AS "Country",
  PEO.SEX                                        AS "Gender",
  ASMT.MANAGER_FLAG                              AS "Manager Flag",
  CASE
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) < 30.0000
    THEN 'Band 1: < 30 Years'
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) BETWEEN 30.0000 AND 39.9999
    THEN 'Band 2: 30-40 Years'
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) BETWEEN 40.0000 AND 49.9999
    THEN 'Band 3:40-50 Years'
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) > 50.0000
    THEN 'Band 4: > 50 Years'
    ELSE 'No DOB'
  END AS "Age Band",
  CASE
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END <= 0.5000
    THEN '<= 6 months'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 0.5001 AND 1.0000
    THEN 'Between 6 months and 1 Year'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 1.0001 AND 2.0000
    THEN 'Between 1 and 2 Years'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 2.0001 AND 4.0000
    THEN 'Between 2 and 4 Years'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 4.0001 AND 7.0000
    THEN 'Between 4 and 7 Years'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END >= 7.0001
    THEN '> 7 Years'
    ELSE NULL
  END AS "Tenure Band",
  CASE
    WHEN initcap(HR_SEPARATION_MAP.LVL1_CD_DESC_TXT) IN('Resigned')
    AND ASMT2.EVENT_LEAVING_REASON_CD NOT            IN('R14')
    AND ASMT2.EVENT_LEAVING_REASON_CD NOT            IN('R15')
    THEN 'Voluntary'
    WHEN ASMT2.EVENT_LEAVING_REASON_CD              = 'R14'
    OR ASMT2.EVENT_LEAVING_REASON_CD               <>'R15'
    OR initcap(HR_SEPARATION_MAP.LVL1_CD_DESC_TXT) IN('Deceased', 'Retirement')
    THEN 'Other'
    ELSE 'Involuntary'
  END                        AS "Separation Flag",
  COUNT(PEO.EMPLOYEE_NUMBER) AS "CT"
FROM RHEDW_STG.STG_EBS_PER_ALL_PPL_F PEO,
  RHEDW_STG.STG_EBS_PER_PERIODS_OF_SERVICE SVC,
  RHEDW_STG.STG_EBS_PER_ALL_ASSIGNMENTS_F ASMT,
  RHEDW.HR_EBS_EMP_ASSGNMNT_F ASMT2,
  RHEDW_STG.STG_EBS_HR_LOCATIONS_ALL LOC,
  RHEDW_STG.STG_EBS_HR_ALL_ORGN_UNT ORG_D,
  RHEDW_STG.STG_EBS_PER_PERSON_TYPES PERTYPES,
  RHEDW_STG.STG_EBS_PER_JOBS JOBS,
  RHEDW.DW_GENERIC_LKP HR_CC_DEPT_MAP,
  RHEDW.DW_GENERIC_LKP HR_LOC_REGION_MAP,
  RHEDW.DW_GENERIC_LKP HR_LOC_COUNTRY_MAP,
  RHEDW.DM_GNRC_CODE_D HR_SEPARATION_MAP
WHERE SVC.actual_termination_date BETWEEN PEO.EFFECTIVE_START_DATE AND PEO.EFFECTIVE_END_DATE
AND SVC.actual_termination_date BETWEEN '01-jan-2014' AND '31-dec-2014'
AND SVC.PERSON_ID      = PEO.PERSON_ID
AND PEO.PERSON_TYPE_ID = PERTYPES.PERSON_TYPE_ID
AND SVC.actual_termination_date BETWEEN asmt.EFFECTIVE_START_DATE AND asmt.EFFECTIVE_END_DATE
AND ASMT.PERSON_ID                  = ASMT2.HR_EBS_PERSON_DID
AND ASMT.JOB_ID                     = JOBS.JOB_ID
AND JOBS.NAME NOT                  IN('Unclassified.Intern.Intern.INTRN','Unclassified.Contractor.Unpaid Intern.999')
AND ASMT.EMPLOYMENT_CATEGORY       IN('FR','PR')
AND ASMT.EFFECTIVE_START_DATE       = ASMT2.ASSGNMNT_START_DT
AND ASMT2.PRIMARY_FLG               = 'Y'
AND ASMT.PRIMARY_FLAG               = 'Y'
AND PEO.STG_DEL_FLG                <> 'Y'
AND ASMT.STG_DEL_FLG               <> 'Y'
AND LOC.STG_DEL_FLG                <> 'Y'
AND JOBS.STG_DEL_FLG               <> 'Y'
AND ORG_D.STG_DEL_FLG              <> 'Y'
AND SVC.STG_DEL_FLG                <> 'Y'
AND HR_CC_DEPT_MAP.DELETED_FLG     <> 'Y'
AND HR_LOC_REGION_MAP.DELETED_FLG  <> 'Y'
AND HR_LOC_COUNTRY_MAP.DELETED_FLG <> 'Y'
AND HR_SEPARATION_MAP.DM_DEL_FLG   <> 'Y'
AND ASMT2.LEAVING_REASON_CD         = HR_SEPARATION_MAP.LVL1_CD(+)
AND HR_SEPARATION_MAP.CD_CTGRY     IN('LEAV_REAS')
AND PEO.PERSON_ID                   = ASMT.PERSON_ID
AND (PERTYPES.SYSTEM_PERSON_TYPE   IN('EMP')
OR PERTYPES.SYSTEM_PERSON_TYPE     IN('EX_EMP'))
AND ASMT.LOCATION_ID                = LOC.LOCATION_ID
AND ASMT.ORGANIZATION_ID            = ORG_D.ORGANIZATION_ID
  --Grouping by Department
AND HR_CC_DEPT_MAP.SUBJECT_AREA_NM IN('HR')
AND HR_CC_DEPT_MAP.LIST_NM         IN('HR_CC_DEPT_MAP')
AND HR_CC_DEPT_MAP.EXPRTN_DT        = TO_DATE('99991231', 'yyyymmdd')
AND HR_CC_DEPT_MAP.LIST_VALUE_CD(+) = SUBSTR(ORG_D.NAME, -3)
  --Grouping by Region
AND HR_LOC_REGION_MAP.SUBJECT_AREA_NM IN('HR')
AND HR_LOC_REGION_MAP.LIST_NM         IN('HR_LOC_REGION_MAP')
AND HR_LOC_REGION_MAP.EXPRTN_DT        = TO_DATE('99991231', 'yyyymmdd')
AND LOC.LOCATION_CODE                  =HR_LOC_REGION_MAP.LIST_VALUE_CD(+)
  --Grouping by Country
AND HR_LOC_COUNTRY_MAP.SUBJECT_AREA_NM IN('HR')
AND HR_LOC_COUNTRY_MAP.LIST_NM         IN('HR_LOC_COUNTRY_MAP')
AND HR_LOC_COUNTRY_MAP.EXPRTN_DT        = TO_DATE('99991231', 'yyyymmdd')
AND LOC.LOCATION_CODE                   =HR_LOC_COUNTRY_MAP.LIST_VALUE_CD(+)
GROUP BY SUBSTR(SVC.actual_termination_date, 4, 6),
  HR_CC_DEPT_MAP.LIST_VALUE_LONG_DESC,
  HR_LOC_REGION_MAP.LIST_VALUE_LONG_DESC,
  HR_LOC_COUNTRY_MAP.LIST_VALUE_LONG_DESC,
  PEO.SEX,
  CASE
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) < 30.0000
    THEN 'Band 1: < 30 Years'
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) BETWEEN 30.0000 AND 39.9999
    THEN 'Band 2: 30-40 Years'
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) BETWEEN 40.0000 AND 49.9999
    THEN 'Band 3:40-50 Years'
    WHEN ROUND((SYSDATE - PEO.DATE_OF_BIRTH)/365.25,2) > 50.0000
    THEN 'Band 4: > 50 Years'
    ELSE 'No DOB'
  END,
  CASE
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END <= 0.5000
    THEN '<= 6 months'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 0.5001 AND 1.0000
    THEN 'Between 6 months and 1 Year'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 1.0001 AND 2.0000
    THEN 'Between 1 and 2 Years'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 2.0001 AND 4.0000
    THEN 'Between 2 and 4 Years'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END BETWEEN 4.0001 AND 7.0000
    THEN 'Between 4 and 7 Years'
    WHEN
      CASE
        WHEN SVC.ADJUSTED_SVC_DATE IS NOT NULL
        THEN ROUND((SYSDATE - SVC.ADJUSTED_SVC_DATE)/365.25,4)
        WHEN SVC.DATE_START IS NOT NULL
        THEN ROUND((SYSDATE - SVC.DATE_START)/365.25,4)
        ELSE ROUND((SYSDATE - PEO.ORIGINAL_DATE_OF_HIRE)/365.25,4)
      END >= 7.0001
    THEN '> 7 Years'
    ELSE NULL
  END,
  ASMT.MANAGER_FLAG,
  CASE
    WHEN initcap(HR_SEPARATION_MAP.LVL1_CD_DESC_TXT) IN('Resigned')
    AND ASMT2.EVENT_LEAVING_REASON_CD NOT            IN('R14')
    AND ASMT2.EVENT_LEAVING_REASON_CD NOT            IN('R15')
    THEN 'Voluntary'
    WHEN ASMT2.EVENT_LEAVING_REASON_CD              = 'R14'
    OR ASMT2.EVENT_LEAVING_REASON_CD               <>'R15'
    OR initcap(HR_SEPARATION_MAP.LVL1_CD_DESC_TXT) IN('Deceased', 'Retirement')
    THEN 'Other'
    ELSE 'Involuntary'
  END
ORDER BY
  CASE
    WHEN initcap(HR_SEPARATION_MAP.LVL1_CD_DESC_TXT) IN('Resigned')
    AND ASMT2.EVENT_LEAVING_REASON_CD NOT            IN('R14')
    AND ASMT2.EVENT_LEAVING_REASON_CD NOT            IN('R15')
    THEN 'Voluntary'
    WHEN ASMT2.EVENT_LEAVING_REASON_CD              = 'R14'
    OR ASMT2.EVENT_LEAVING_REASON_CD               <>'R15'
    OR initcap(HR_SEPARATION_MAP.LVL1_CD_DESC_TXT) IN('Deceased', 'Retirement')
    THEN 'Other'
    ELSE 'Involuntary'
  END;
